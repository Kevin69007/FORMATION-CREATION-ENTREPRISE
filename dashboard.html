<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formation Entrepreneuriat - Accueil</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="formation-layout">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-info" onclick="goToProfile()" style="cursor: pointer;">
                    <div class="user-avatar" id="userAvatar">KJ</div>
                    <div class="user-details">
                        <h3 id="userName">Kevin JEAN</h3>
                        <p>√âtudiant</p>
                    </div>
                </div>
                <div class="progress-info">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Progression</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <nav class="navigation" id="navigation">
                <!-- Navigation will be generated by JavaScript -->
            </nav>

            <div style="padding: 20px;">
                <button onclick="logout()" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 10px;">
                    D√©connexion
                </button>
                <button onclick="switchToAdminMode()" id="adminModeBtn" style="width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; display: none;">
                    üîß Mode Admin
                </button>
            </div>
        </div>

        <!-- Contenu principal -->
        <div class="main-content">
            <div class="content-header">
                <h1 class="content-title">Bienvenue dans la Formation</h1>
                <p class="content-subtitle">Formation compl√®te en entrepreneuriat</p>
            </div>

            <div class="welcome-content">
                <div class="welcome-video">
                    <div class="video-container">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                            <h3>üé• Vid√©o d'introduction √† la formation</h3>
                            <iframe width="560" height="315" autoplay controls src="https://youtube.com/embed/MFZNG1OcOok" frameborder="0" allowfullscreen style="max-width: 100%; border-radius: 8px;"></iframe>
                        </div>
                    </div>
                </div>

                <div class="welcome-text">
                    <h2>üéØ √Ä propos de cette formation</h2>
                    <p>Cette formation vous accompagnera dans votre parcours entrepreneurial, de la conception de votre projet √† sa r√©alisation concr√®te. Vous d√©couvrirez les comp√©tences essentielles, les outils pratiques et les strat√©gies √©prouv√©es pour r√©ussir en tant que chef d'entreprise.</p>
                    
                    <h3>üìö Ce que vous allez apprendre :</h3>
                    <ul>
                        <li>Les comp√©tences cl√©s de l'entrepreneuriat</li>
                        <li>Comment analyser et comprendre votre march√©</li>
                        <li>La structuration juridique et fiscale de votre projet</li>
                        <li>Les strat√©gies commerciales et de distribution</li>
                        <li>La gestion financi√®re et les aides disponibles</li>
                    </ul>
                </div>

                <div class="start-formation">
                    <a href="#" onclick="startFirstLesson()" class="start-button">
                        Commencer la formation
                    </a>
                </div>

                <div class="formation-stats" style="margin-top: 50px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                        <h3 style="color: #667eea; font-size: 32px; margin-bottom: 5px;" id="totalModules">13</h3>
                        <p style="color: #6c757d;">Modules</p>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                        <h3 style="color: #28a745; font-size: 32px; margin-bottom: 5px;" id="completedLessons">0</h3>
                        <p style="color: #6c757d;">Le√ßons termin√©es</p>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                        <h3 style="color: #fd7e14; font-size: 32px; margin-bottom: 5px;" id="totalLessons">0</h3>
                        <p style="color: #6c757d;">Le√ßons totales</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="admin/admin-api.js"></script>
    <script>
        // V√©rifier l'authentification
        checkAuth();
        
        // V√©rifier le mode admin
        const urlParams = new URLSearchParams(window.location.search);
        const isAdminMode = urlParams.get('mode') === 'admin' && localStorage.getItem('username') === 'admin';
        
        // Initialiser le dashboard
        if (isAdminMode) {
            initializeAdminDashboard();
        } else {
            initializeDashboard();
            // Afficher le bouton admin si l'utilisateur est admin
            if (localStorage.getItem('username') === 'admin') {
                const adminBtn = document.getElementById('adminModeBtn');
                if (adminBtn) {
                    adminBtn.style.display = 'block';
                }
            }
        }
        
        function startFirstLesson() {
            // Rediriger vers la premi√®re le√ßon
            window.location.href = 'lesson.html?module=1&lesson=1';
        }
        
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            localStorage.removeItem('loginTime');
            window.location.href = 'index.html';
        }
        
        function goToProfile() {
            window.location.href = 'profile.html';
        }
        
        function switchToStudentMode() {
            window.location.href = 'dashboard.html';
        }
        
        function switchToAdminMode() {
            window.location.href = 'dashboard.html?mode=admin';
        }
        
        // Fonction pour initialiser le dashboard admin
        function initializeAdminDashboard() {
            // Remplacer le contenu principal par l'interface admin
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div class="content-header">
                    <h1 class="content-title">Administration - Formation Entrepreneuriat</h1>
                    <p class="content-subtitle">Gestion des √©tudiants et suivi des progressions</p>
                    <div style="margin-top: 20px;">
                        <button onclick="switchToStudentMode()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                            üë®‚Äçüéì Mode √âtudiant
                        </button>
                        <button onclick="refreshStudents()" style="background: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                            üîÑ Actualiser
                        </button>
                        <button onclick="exportData()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">
                            üì• Exporter CSV
                        </button>
                    </div>
                </div>
                
                <div class="admin-content">
                    <!-- Statistiques globales -->
                    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                            <div class="stat-number" id="totalUsers" style="font-size: 36px; font-weight: bold; color: #007bff; margin-bottom: 5px;">0</div>
                            <div class="stat-label" style="color: #6c757d; font-size: 14px;">Utilisateurs inscrits</div>
                        </div>
                        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                            <div class="stat-number" id="activeUsers" style="font-size: 36px; font-weight: bold; color: #007bff; margin-bottom: 5px;">0</div>
                            <div class="stat-label" style="color: #6c757d; font-size: 14px;">Utilisateurs actifs</div>
                        </div>
                        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                            <div class="stat-number" id="avgProgress" style="font-size: 36px; font-weight: bold; color: #007bff; margin-bottom: 5px;">0%</div>
                            <div class="stat-label" style="color: #6c757d; font-size: 14px;">Progression moyenne</div>
                        </div>
                        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                            <div class="stat-number" style="font-size: 36px; font-weight: bold; color: #007bff; margin-bottom: 5px;">13</div>
                            <div class="stat-label" style="color: #6c757d; font-size: 14px;">Modules disponibles</div>
                        </div>
                    </div>

                    <!-- Tableau des utilisateurs -->
                    <div class="users-table" style="background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;">
                        <div class="table-header" style="background: #f8f9fa; padding: 20px; border-bottom: 1px solid #dee2e6;">
                            <h2 style="color: #2c3e50; margin: 0;">üìä Liste des √©tudiants</h2>
                        </div>
                        <div class="table-container" style="overflow-x: auto;">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; background: #f8f9fa; font-weight: 600; color: #2c3e50;">Nom d'utilisateur</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; background: #f8f9fa; font-weight: 600; color: #2c3e50;">Nom complet</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; background: #f8f9fa; font-weight: 600; color: #2c3e50;">Email</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; background: #f8f9fa; font-weight: 600; color: #2c3e50;">Date de cr√©ation</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; background: #f8f9fa; font-weight: 600; color: #2c3e50;">Progression</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; background: #f8f9fa; font-weight: 600; color: #2c3e50;">Le√ßons termin√©es</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; background: #f8f9fa; font-weight: 600; color: #2c3e50;">Derni√®re activit√©</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; background: #f8f9fa; font-weight: 600; color: #2c3e50;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <!-- Les donn√©es seront charg√©es dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // Charger les donn√©es admin
            loadAdminData();
        }
        
        // Fonction pour charger les donn√©es admin
        function loadAdminData() {
            if (typeof adminAPI !== 'undefined') {
                const userData = adminAPI.loadUserData();
                updateAdminStats(userData);
                updateStudentsTable(userData);
            } else {
                console.error('adminAPI non disponible');
            }
        }
        
        // Fonction pour mettre √† jour les statistiques admin
        function updateAdminStats(userData) {
            const totalUsers = Object.keys(userData).length;
            let activeUsers = 0;
            let totalCompletions = 0;

            Object.values(userData).forEach(user => {
                const completedLessons = user.completed_lessons || 0;
                if (completedLessons > 0) {
                    activeUsers++;
                }
                totalCompletions += completedLessons;
            });

            const avgProgress = totalUsers > 0 ? Math.round((totalCompletions / (totalUsers * 77)) * 100) : 0;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('avgProgress').textContent = avgProgress + '%';
        }
        
        // Fonction pour mettre √† jour le tableau des √©tudiants
        function updateStudentsTable(userData) {
            const tbody = document.getElementById('studentsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            Object.entries(userData).forEach(([username, data]) => {
                const completedCount = data.completed_lessons || 0;
                const completionRate = data.completion_rate || 0;
                const lastActivity = data.last_activity || 'Jamais';
                const firstName = data.firstName || '';
                const lastName = data.lastName || '';
                const email = data.email || '';
                const fullName = (firstName + ' ' + lastName).trim() || 'Non renseign√©';
                const creationDate = data.first_login || data.created_at || 'N/A';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6;"><strong>${username}</strong></td>
                    <td style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6;">${fullName}</td>
                    <td style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6;">${email || 'Non renseign√©'}</td>
                    <td style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6;">${creationDate !== 'N/A' ? new Date(creationDate).toLocaleDateString() : 'N/A'}</td>
                    <td style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 100px; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden;">
                                <div style="height: 100%; background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%); width: ${completionRate}%; transition: width 0.3s ease;"></div>
                            </div>
                            <small style="font-weight: 600; color: #2c3e50;">${completionRate}%</small>
                        </div>
                    </td>
                    <td style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6;">
                        <span style="font-weight: 600; color: #28a745;">${completedCount} / 77</span>
                    </td>
                    <td style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6;">${lastActivity !== 'Jamais' ? new Date(lastActivity).toLocaleString() : 'Jamais'}</td>
                    <td style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6;">
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button onclick="viewStudentDashboard('${username}')" style="background: #007bff; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;" title="Voir le dashboard">
                                üëÅÔ∏è Dashboard
                            </button>
                            <button onclick="deleteStudent('${username}')" style="background: #dc3545; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;" title="Supprimer">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Fonctions admin
        function refreshStudents() {
            loadAdminData();
        }
        
        function exportData() {
            if (typeof adminAPI !== 'undefined') {
                const csvContent = adminAPI.exportCSV();
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `formation_progress_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            }
        }
        
        function viewStudentDashboard(username) {
            // Ouvrir le dashboard √©tudiant dans un nouvel onglet
            window.open(`dashboard.html?student=${username}`, '_blank');
        }
        
        function deleteStudent(username) {
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer l'√©tudiant "${username}" ?`)) {
                if (typeof adminAPI !== 'undefined') {
                    const result = adminAPI.deleteStudent(username);
                    if (result.success) {
                        alert('√âtudiant supprim√© avec succ√®s !');
                        loadAdminData();
                    } else {
                        alert('Erreur lors de la suppression: ' + result.message);
                    }
                }
            }
        }
    </script>
</body>
</html>