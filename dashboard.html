<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formation Entrepreneuriat - Accueil</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="formation-layout">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-info" onclick="goToProfile()" style="cursor: pointer;">
                    <div class="user-avatar" id="userAvatar">KJ</div>
                    <div class="user-details">
                        <h3 id="userName">Kevin JEAN</h3>
                        <p>√âtudiant</p>
                    </div>
                </div>
                <div class="progress-info">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Progression</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <nav class="navigation" id="navigation">
                <!-- Navigation will be generated by JavaScript -->
            </nav>
            
            <!-- Lien vers le profil toujours visible -->
            <div style="padding: 20px 0; border-top: 1px solid #e1e5e9; margin-top: 20px;">
                <a href="profile.html" class="profile-link" style="display: flex; align-items: center; padding: 12px 20px; color: #667eea; text-decoration: none; border-radius: 8px; transition: background-color 0.3s; font-weight: 600;">
                    <span style="margin-right: 10px; font-size: 18px;">üë§</span>
                    Mon Profil
                </a>
            </div>

            <div style="padding: 20px;">
                <button onclick="logout()" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 10px;">
                    D√©connexion
                </button>
            </div>
        </div>

        <!-- Contenu principal -->
        <div class="main-content">
            <div class="content-header">
                <h1 class="content-title">Bienvenue dans la Formation</h1>
                <p class="content-subtitle">Formation compl√®te en entrepreneuriat</p>
            </div>

            <div class="welcome-content">
                <div class="welcome-video">
                    <div class="video-container">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                            <h3>üé• Vid√©o d'introduction √† la formation</h3>
                            <iframe width="560" height="315" autoplay controls src="https://youtube.com/embed/MFZNG1OcOok" frameborder="0" allowfullscreen style="max-width: 100%; border-radius: 8px;"></iframe>
                        </div>
                    </div>
                </div>

                <div class="welcome-text">
                    <h2>üéØ √Ä propos de cette formation</h2>
                    <p>Cette formation vous accompagnera dans votre parcours entrepreneurial, de la conception de votre projet √† sa r√©alisation concr√®te. Vous d√©couvrirez les comp√©tences essentielles, les outils pratiques et les strat√©gies √©prouv√©es pour r√©ussir en tant que chef d'entreprise.</p>
                    
                    <h3>üìö Ce que vous allez apprendre :</h3>
                    <ul>
                        <li>Les comp√©tences cl√©s de l'entrepreneuriat</li>
                        <li>Comment analyser et comprendre votre march√©</li>
                        <li>La structuration juridique et fiscale de votre projet</li>
                        <li>Les strat√©gies commerciales et de distribution</li>
                        <li>La gestion financi√®re et les aides disponibles</li>
                    </ul>
                </div>

                <div class="start-formation">
                    <a href="#" id="startFormationBtn" class="start-button">
                        Commencer la formation
                    </a>
                </div>

                <div class="formation-stats" style="margin-top: 50px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                        <h3 style="color: #667eea; font-size: 32px; margin-bottom: 5px;" id="totalModules">13</h3>
                        <p style="color: #6c757d;">Modules</p>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                        <h3 style="color: #28a745; font-size: 32px; margin-bottom: 5px;" id="completedLessons">0</h3>
                        <p style="color: #6c757d;">Le√ßons termin√©es</p>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                        <h3 style="color: #fd7e14; font-size: 32px; margin-bottom: 5px;" id="totalLessons">0</h3>
                        <p style="color: #6c757d;">Le√ßons totales</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="api-client.js"></script>
    <script src="script.js"></script>
    <script src="admin/admin-api.js"></script>
    <script>
        // Fonction pour d√©marrer la premi√®re le√ßon (d√©finie en premier pour √™tre disponible)
        window.startFirstLesson = async function() {
            try {
                console.log('üöÄ D√©marrage de la formation...');
                
                // Initialiser la progression si elle n'existe pas
                let progress = JSON.parse(localStorage.getItem('lessonProgress') || '{}');
                const username = localStorage.getItem('username');
                
                // V√©rifier si c'est la premi√®re fois que l'utilisateur commence
                const firstLessonKey = 'module_1_lesson_1';
                const isFirstTime = !progress[firstLessonKey];
                
                if (isFirstTime) {
                    console.log('üìù Premi√®re visite - Initialisation de la progression');
                    // Initialiser la premi√®re le√ßon comme commenc√©e (mais pas termin√©e)
                    progress[firstLessonKey] = {
                        started: true,
                        startedAt: new Date().toISOString(),
                        completed: false,
                        timeSpent: 0
                    };
                    localStorage.setItem('lessonProgress', JSON.stringify(progress));
                    
                    // Synchroniser avec l'API externe si disponible
                    if (window.apiClient) {
                        try {
                            await window.apiClient.updateProgress({
                                moduleId: 'module1',
                                lessonId: 'lesson1',
                                completed: false,
                                timeSpent: 0
                            });
                            console.log('‚úÖ Progression initialis√©e et synchronis√©e avec l\'API');
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Impossible de synchroniser avec l\'API:', error);
                        }
                    }
                }
                
                // Mettre √† jour les statistiques avant de rediriger
                if (typeof updateProgress === 'function') {
                    updateProgress();
                }
                
                // Rediriger vers la premi√®re le√ßon
                console.log('‚û°Ô∏è Redirection vers la premi√®re le√ßon...');
                window.location.href = 'lesson.html?module=1&lesson=1';
            } catch (error) {
                console.error('‚ùå Erreur lors du d√©marrage de la formation:', error);
                alert('Erreur lors du d√©marrage de la formation. Veuillez r√©essayer.');
            }
        };
        
        // Charger la progression depuis l'API si disponible
        async function loadProgressFromAPI() {
            if (window.apiClient) {
                try {
                    const progressData = await window.apiClient.getProgress();
                    if (progressData && progressData.progress) {
                        // Convertir la progression de l'API au format localStorage
                        const localProgress = {};
                        for (const moduleId in progressData.progress) {
                            for (const lessonId in progressData.progress[moduleId]) {
                                const lesson = progressData.progress[moduleId][lessonId];
                                // Extraire les IDs num√©riques (module1 -> 1, lesson1 -> 1)
                                const moduleNum = moduleId.replace('module', '');
                                const lessonNum = lessonId.replace('lesson', '');
                                const lessonKey = `module_${moduleNum}_lesson_${lessonNum}`;
                                localProgress[lessonKey] = {
                                    completed: lesson.completed || false,
                                    timeSpent: lesson.timeSpent || 0,
                                    completedAt: lesson.lastAccessed || null
                                };
                            }
                        }
                        // Fusionner avec la progression locale (la locale a priorit√©)
                        const existingProgress = JSON.parse(localStorage.getItem('lessonProgress') || '{}');
                        const mergedProgress = { ...localProgress, ...existingProgress };
                        localStorage.setItem('lessonProgress', JSON.stringify(mergedProgress));
                        
                        // Mettre √† jour l'affichage
                        if (typeof updateProgress === 'function') {
                            updateProgress();
                        }
                        if (typeof generateNavigation === 'function') {
                            generateNavigation();
                        }
                    }
                } catch (error) {
                    console.warn('Impossible de charger la progression depuis l\'API:', error);
                }
            }
        }
        
        // Attendre que le DOM soit compl√®tement charg√©
        document.addEventListener('DOMContentLoaded', function() {
            // V√©rifier l'authentification
            checkAuth();
            
            // V√©rifier si l'utilisateur est admin et rediriger vers l'interface admin
            const userType = localStorage.getItem('userType');
            if (userType === 'ADMIN' || userType === 'admin') {
                window.location.href = 'admin/index.html';
                return;
            }
            
            // Initialiser le dashboard √©tudiant
            initializeDashboard();
            
            // Charger la progression au d√©marrage
            loadProgressFromAPI();
            
            // Attacher l'√©v√©nement au bouton "Commencer la formation"
            const startBtn = document.getElementById('startFormationBtn');
            if (startBtn) {
                startBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('üñ±Ô∏è Clic sur le bouton "Commencer la formation"');
                    if (typeof window.startFirstLesson === 'function') {
                        window.startFirstLesson();
                    } else {
                        console.error('‚ùå Fonction startFirstLesson non disponible');
                        // Fallback : redirection directe
                        window.location.href = 'lesson.html?module=1&lesson=1';
                    }
                });
                console.log('‚úÖ Bouton "Commencer la formation" initialis√©');
            } else {
                console.error('‚ùå Bouton "Commencer la formation" non trouv√©');
            }
        });
        
        function goToProfile() {
            window.location.href = 'profile.html';
        }
        
        window.goToProfile = goToProfile;
        
    </script>
</body>
</html>