<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formation Entrepreneuriat - Connexion</title>
    <link rel="stylesheet" href="style.css">
    <script src="admin/admin-api.js"></script>
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1>Formation Entrepreneuriat</h1>
                <p>Connectez-vous pour acc√©der √† votre formation</p>
            </div>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username">Nom d'utilisateur</label>
                    <input type="text" id="username" name="username" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Mot de passe</label>
                    <input type="password" id="password" name="password" required>
                </div>
                
                <button type="submit" class="login-btn">Se connecter</button>
                
                <div id="errorMessage" class="error-message" style="display: none;"></div>
            </form>
            
            <!-- Section de cr√©ation de compte admin -->
            <div id="adminCreationSection" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #007bff;">
                <h3 style="color: #007bff; margin-bottom: 15px;">üîß Cr√©er un compte administrateur</h3>
                <form id="adminCreationForm">
                    <div class="form-group">
                        <label for="adminUsername">Nom d'utilisateur admin</label>
                        <input type="text" id="adminUsername" name="adminUsername" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminPassword">Mot de passe admin</label>
                        <input type="password" id="adminPassword" name="adminPassword" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminConfirmPassword">Confirmer le mot de passe</label>
                        <input type="password" id="adminConfirmPassword" name="adminConfirmPassword" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminEmail">Email administrateur</label>
                        <input type="email" id="adminEmail" name="adminEmail" required>
                    </div>
                    
                    <button type="submit" class="login-btn" style="background: #28a745;">Cr√©er le compte admin</button>
                    <button type="button" onclick="toggleAdminCreation()" class="login-btn" style="background: #6c757d; margin-left: 10px;">Annuler</button>
                </form>
                <div id="adminCreationMessage" class="error-message" style="display: none;"></div>
            </div>
            
            <div style="text-align: center; margin-top: 15px;">
                <button onclick="toggleAdminCreation()" style="background: none; border: none; color: #007bff; text-decoration: underline; cursor: pointer;">
                    üîß Cr√©er un compte administrateur
                </button>
            </div>
        </div>
    </div>

    <script>
        // Charger l'API admin
        const adminAPI = new AdminAPI();
        
        // Syst√®me de connexion am√©lior√©
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('errorMessage');
            
            // Essayer de se connecter via l'API
            try {
                const userData = adminAPI.getUser(username);
                
                if (userData && userData.password) {
                    // V√©rifier le mot de passe (simple comparaison pour la d√©mo)
                    const storedPassword = userData.password;
                    let passwordMatch = false;
                    
                    // V√©rifier si c'est un mot de passe hash√© (PHP) ou encod√© (JS)
                    if (storedPassword.startsWith('$2y$')) {
                        // Mot de passe hash√© PHP - pour l'instant on utilise une v√©rification simple
                        passwordMatch = (password === 'admin2024' && username === 'admin');
                    } else {
                        // Mot de passe encod√© en base64 (JS)
                        passwordMatch = (btoa(password) === storedPassword);
                    }
                    
                    if (passwordMatch) {
                        // Sauvegarder la session
                        localStorage.setItem('isLoggedIn', 'true');
                        localStorage.setItem('username', username);
                        localStorage.setItem('userType', username === 'admin' ? 'admin' : 'student');
                        localStorage.setItem('loginTime', new Date().toISOString());
                        
                        // Enregistrer la connexion
                        adminAPI.userLogin(username);
                        
                        // Rediriger vers le dashboard
                        if (username === 'admin') {
                            window.location.href = 'admin/index.html';
                        } else {
                            window.location.href = 'dashboard.html';
                        }
                        return;
                    }
                }
                
                // Fallback vers les identifiants par d√©faut
                const validUsers = {
                    'etudiant': 'formation2024',
                    'admin': 'admin2024'
                };
                
                if (validUsers[username] && validUsers[username] === password) {
                    // Sauvegarder la session
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('username', username);
                    localStorage.setItem('userType', username === 'admin' ? 'admin' : 'student');
                    localStorage.setItem('loginTime', new Date().toISOString());
                    
                    // Enregistrer la connexion
                    adminAPI.userLogin(username);
                    
                    // Rediriger vers le dashboard
                    if (username === 'admin') {
                        window.location.href = 'admin/index.html';
                    } else {
                        window.location.href = 'dashboard.html';
                    }
                } else {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = 'Nom d\'utilisateur ou mot de passe incorrect';
                }
            } catch (error) {
                console.error('Erreur lors de la connexion:', error);
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Erreur lors de la connexion. Veuillez r√©essayer.';
            }
        });

        // Gestion de la cr√©ation de compte admin
        document.getElementById('adminCreationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const adminData = {
                username: formData.get('adminUsername'),
                password: formData.get('adminPassword'),
                confirmPassword: formData.get('adminConfirmPassword'),
                email: formData.get('adminEmail')
            };
            
            const messageDiv = document.getElementById('adminCreationMessage');
            
            // Validation
            if (adminData.password !== adminData.confirmPassword) {
                messageDiv.style.display = 'block';
                messageDiv.textContent = 'Les mots de passe ne correspondent pas';
                return;
            }
            
            if (adminData.password.length < 6) {
                messageDiv.style.display = 'block';
                messageDiv.textContent = 'Le mot de passe doit contenir au moins 6 caract√®res';
                return;
            }
            
            try {
                // Cr√©er le compte admin
                const result = adminAPI.createStudent({
                    username: adminData.username,
                    firstName: 'Admin',
                    lastName: 'Syst√®me',
                    email: adminData.email,
                    password: adminData.password,
                    enrollmentDate: new Date().toISOString().split('T')[0]
                });
                
                if (result.success) {
                    messageDiv.style.display = 'block';
                    messageDiv.style.color = 'green';
                    messageDiv.textContent = '‚úÖ Compte administrateur cr√©√© avec succ√®s ! Vous pouvez maintenant vous connecter.';
                    
                    // Masquer le formulaire apr√®s 3 secondes
                    setTimeout(() => {
                        toggleAdminCreation();
                        messageDiv.style.display = 'none';
                    }, 3000);
                } else {
                    messageDiv.style.display = 'block';
                    messageDiv.textContent = 'Erreur: ' + result.message;
                }
            } catch (error) {
                console.error('Erreur lors de la cr√©ation du compte admin:', error);
                messageDiv.style.display = 'block';
                messageDiv.textContent = 'Erreur lors de la cr√©ation du compte: ' + error.message;
            }
        });

        // Fonction pour afficher/masquer la section de cr√©ation admin
        function toggleAdminCreation() {
            const section = document.getElementById('adminCreationSection');
            const messageDiv = document.getElementById('adminCreationMessage');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                messageDiv.style.display = 'none';
                // R√©initialiser le formulaire
                document.getElementById('adminCreationForm').reset();
            } else {
                section.style.display = 'none';
                messageDiv.style.display = 'none';
            }
        }

        // V√©rifier si d√©j√† connect√© au chargement de la page
        window.addEventListener('load', function() {
            if (localStorage.getItem('isLoggedIn') === 'true') {
                const username = localStorage.getItem('username');
                if (username === 'admin') {
                    window.location.href = 'admin/index.html';
                } else {
                    window.location.href = 'dashboard.html';
                }
            }
        });
    </script>
</body>
</html>